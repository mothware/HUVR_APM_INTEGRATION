@{
    ViewData["Title"] = "Multi-Sheet Excel Export";
}

<div class="row mb-3">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Home</a></li>
                <li class="breadcrumb-item active">Excel Export</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="btn-group" role="group">
            <a href="@Url.Action("FieldMapping", "Excel")" class="btn btn-outline-primary">
                <i class="bi bi-file-earmark-excel"></i> Single Sheet Export
            </a>
            <a href="@Url.Action("MultiSheetMapping", "Excel")" class="btn btn-primary active">
                <i class="bi bi-files"></i> Multi-Sheet Export
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0"><i class="bi bi-files me-2"></i>Multi-Sheet Excel Export with Model Linking</h3>
                <small>Create Excel workbooks with multiple sheets and cross-model data linking</small>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong><i class="bi bi-info-circle me-2"></i>Instructions:</strong> Configure multiple sheets with different entity types. You can map fields from related entities using dot notation (e.g., "Asset.Name" for a Project's related Asset).
                    <br><small class="mt-2 d-block"><strong>Tip:</strong> Configure starting rows per sheet to leave space for headers or logos!</small>
                </div>

                <div class="mb-4">
                    <button id="addSheetBtn" class="btn btn-primary btn-lg">
                        <i class="bi bi-plus-circle me-2"></i>Add Sheet
                    </button>
                    <button id="exportAllBtn" class="btn btn-success btn-lg ms-2" style="display:none;">
                        <i class="bi bi-file-earmark-excel me-2"></i>Export All Sheets
                    </button>
                    <button id="clearAllBtn" class="btn btn-danger btn-lg ms-2" style="display:none;">
                        <i class="bi bi-trash me-2"></i>Clear All
                    </button>
                </div>

                <div id="sheetsContainer"></div>

                <div id="loading" class="alert alert-warning mt-4" style="display:none;">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span id="loadingText">Processing...</span>
                </div>

                <div id="error" class="alert alert-danger mt-4" style="display:none;"></div>
                <div id="success" class="alert alert-success mt-4" style="display:none;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h4 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Features, Examples & Tips</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="fw-bold"><i class="bi bi-star text-warning me-1"></i>Key Features:</h6>
                        <ul>
                            <li><strong>Multi-Sheet Export:</strong> Create multiple sheets in one Excel file</li>
                            <li><strong>Model Linking:</strong> Access related entity fields automatically</li>
                            <li><strong>Custom Start Row:</strong> Specify which row to start data output (1-N)</li>
                            <li><strong>Field Selection:</strong> Choose which fields to include per sheet</li>
                            <li><strong>Auto-Linking:</strong> Relationships resolved automatically via Id fields</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6 class="fw-bold"><i class="bi bi-link-45deg text-info me-1"></i>Related Entity Examples:</h6>
                        <ul>
                            <li><code>Asset.Name</code> - Access Asset name from a Project</li>
                            <li><code>Asset.Location</code> - Access Asset location from a Project</li>
                            <li><code>User.Email</code> - Access User email from a Defect</li>
                            <li><code>Project.Name</code> - Access Project name from a Defect</li>
                            <li><code>Library.Name</code> - Access Library name from an Asset</li>
                        </ul>
                    </div>
                    <div class="col-md-4">
                        <h6 class="fw-bold"><i class="bi bi-info-circle text-primary me-1"></i>Usage Tips:</h6>
                        <ul>
                            <li>Use <strong>Start Row</strong> to leave space for logos/headers</li>
                            <li>Related fields are marked with a <span class="badge bg-info">Related</span> badge</li>
                            <li>Sheet names can be customized or left to default</li>
                            <li>Add/remove sheets as needed</li>
                            <li>Select which fields to include in each sheet</li>
                            <li>Need single sheet? Try <a href="@Url.Action("FieldMapping", "Excel")">Single Sheet Export</a></li>
                        </ul>
                    </div>
                </div>
                <hr>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6 class="fw-bold"><i class="bi bi-diagram-3 text-success me-1"></i>Example Use Case:</h6>
                        <p class="mb-2">Create a comprehensive project report with:</p>
                        <ol>
                            <li><strong>Sheet 1: "Projects Summary"</strong> - Projects with Asset.Name, Asset.Location (Start Row: 1)</li>
                            <li><strong>Sheet 2: "Defects Report"</strong> - Defects with Project.Name, Asset.Name, User.Email (Start Row: 3)</li>
                            <li><strong>Sheet 3: "Measurements"</strong> - Measurements with Project.Name, Asset.Location (Start Row: 1)</li>
                        </ol>
                        <p class="text-muted"><small>All sheets in one file, all relationships resolved automatically!</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<template id="sheetConfigTemplate">
    <div class="card mb-3 sheet-config border-primary" data-sheet-index="">
        <div class="card-header bg-light border-primary">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="mb-0">
                        <i class="bi bi-file-earmark-spreadsheet text-primary me-2"></i>
                        <span class="sheet-title">Sheet Configuration</span>
                    </h5>
                </div>
                <div class="col-auto">
                    <button class="btn btn-sm btn-danger remove-sheet-btn">
                        <i class="bi bi-trash"></i> Remove Sheet
                    </button>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-tag me-1"></i>Sheet Name
                    </label>
                    <input type="text" class="form-control sheet-name" placeholder="e.g., Projects Summary">
                    <small class="text-muted">Custom name for this sheet</small>
                </div>
                <div class="col-md-3">
                    <label class="form-label fw-bold">
                        <i class="bi bi-database me-1"></i>Entity Type
                    </label>
                    <select class="form-select entity-type">
                        <option value="">-- Select Entity --</option>
                        <option value="assets">Assets</option>
                        <option value="projects">Projects (Work Orders)</option>
                        <option value="defects">Defects (Findings)</option>
                        <option value="measurements">Measurements</option>
                        <option value="inspectionmedia">Inspection Media</option>
                        <option value="checklists">Checklists (Digital Forms)</option>
                        <option value="users">Users</option>
                        <option value="workspaces">Workspaces</option>
                    </select>
                    <small class="text-muted">Data source for this sheet</small>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold">
                        <i class="bi bi-arrows-vertical me-1"></i>Start Row
                    </label>
                    <input type="number" class="form-control start-row" value="1" min="1" max="100">
                    <small class="text-muted">Where to begin data</small>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">
                        <i class="bi bi-gear me-1"></i>Actions
                    </label>
                    <div>
                        <button class="btn btn-primary load-fields-btn w-100">
                            <i class="bi bi-download me-2"></i>Load Available Fields
                        </button>
                    </div>
                </div>
            </div>

            <div class="mapping-section" style="display:none;">
                <hr>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">Field Mappings</h6>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input select-all-fields" checked>
                        <label class="form-check-label">Select All</label>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr>
                                <th width="50">Include</th>
                                <th>API Field</th>
                                <th>Excel Column Name</th>
                                <th>Type</th>
                            </tr>
                        </thead>
                        <tbody class="mapping-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</template>

@section Scripts {
    <script>
        var sheets = [];
        var sheetCounter = 0;

        $(document).ready(function() {
            $('#addSheetBtn').click(function() {
                addSheet();
            });

            $('#exportAllBtn').click(function() {
                exportMultiSheet();
            });

            $('#clearAllBtn').click(function() {
                if (confirm('Are you sure you want to clear all sheets?')) {
                    sheets = [];
                    sheetCounter = 0;
                    $('#sheetsContainer').empty();
                    updateButtons();
                }
            });
        });

        function addSheet() {
            var template = document.getElementById('sheetConfigTemplate');
            var clone = template.content.cloneNode(true);
            var sheetIndex = sheetCounter++;

            $(clone).find('.sheet-config').attr('data-sheet-index', sheetIndex);
            $('#sheetsContainer').append(clone);

            var sheetElement = $('.sheet-config[data-sheet-index="' + sheetIndex + '"]');

            // Update sheet title dynamically
            sheetElement.find('.sheet-title').text('Sheet ' + (sheetIndex + 1) + ' Configuration');

            // Remove button handler
            sheetElement.find('.remove-sheet-btn').click(function() {
                removeSheet(sheetIndex);
            });

            // Load fields button handler
            sheetElement.find('.load-fields-btn').click(function() {
                loadSheetFields(sheetIndex);
            });

            // Select all checkbox handler
            sheetElement.find('.select-all-fields').change(function() {
                var checked = $(this).prop('checked');
                sheetElement.find('.field-checkbox').prop('checked', checked);
            });

            // Sheet name change handler - update title
            sheetElement.find('.sheet-name').on('input', function() {
                var name = $(this).val();
                if (name) {
                    sheetElement.find('.sheet-title').text(name);
                } else {
                    sheetElement.find('.sheet-title').text('Sheet ' + (sheetIndex + 1) + ' Configuration');
                }
            });

            // Entity type change handler - update title hint
            sheetElement.find('.entity-type').on('change', function() {
                var entityType = $(this).val();
                var sheetName = sheetElement.find('.sheet-name').val();
                if (!sheetName && entityType) {
                    var defaultName = $(this).find('option:selected').text().split('(')[0].trim();
                    sheetElement.find('.sheet-name').val(defaultName);
                    sheetElement.find('.sheet-title').text(defaultName);
                }
            });

            sheets[sheetIndex] = {
                index: sheetIndex,
                availableFields: []
            };

            updateButtons();
        }

        function removeSheet(index) {
            $('.sheet-config[data-sheet-index="' + index + '"]').remove();
            delete sheets[index];
            updateButtons();
        }

        function updateButtons() {
            var hasSheets = $('.sheet-config').length > 0;
            $('#exportAllBtn').toggle(hasSheets);
            $('#clearAllBtn').toggle(hasSheets);
        }

        function loadSheetFields(sheetIndex) {
            var sheetElement = $('.sheet-config[data-sheet-index="' + sheetIndex + '"]');
            var entityType = sheetElement.find('.entity-type').val();

            if (!entityType) {
                alert('Please select an entity type');
                return;
            }

            $('#loading').show();
            $('#loadingText').text('Loading fields with relationships...');
            $('#error').hide();
            $('#success').hide();

            $.ajax({
                url: '@Url.Action("GetAvailableFieldsWithRelationships", "Excel")',
                type: 'GET',
                data: { entityType: entityType },
                success: function(response) {
                    $('#loading').hide();

                    if (response.success) {
                        sheets[sheetIndex].availableFields = response.fields;
                        renderSheetFieldMappings(sheetIndex, response.fields);
                        sheetElement.find('.mapping-section').show();
                    } else {
                        $('#error').text('Error: ' + response.error).show();
                    }
                },
                error: function(xhr, status, error) {
                    $('#loading').hide();
                    $('#error').text('Request failed: ' + error).show();
                }
            });
        }

        function renderSheetFieldMappings(sheetIndex, fields) {
            var sheetElement = $('.sheet-config[data-sheet-index="' + sheetIndex + '"]');
            var tbody = sheetElement.find('.mapping-table-body');
            tbody.empty();

            fields.forEach(function(field) {
                var row = $('<tr>');

                var checkboxCell = $('<td class="text-center">').append(
                    $('<input type="checkbox" class="field-checkbox form-check-input">').prop('checked', true)
                );

                var fieldCell = $('<td>').html('<code>' + field.fieldPath + '</code>');

                var badge = field.isRelated
                    ? '<span class="badge bg-info ms-2">Related: ' + field.relatedEntity + '</span>'
                    : '<span class="badge bg-secondary ms-2">Direct</span>';
                fieldCell.append(badge);

                if (field.description) {
                    fieldCell.append('<br><small class="text-muted">' + field.description + '</small>');
                }

                var excelColumnCell = $('<td>').append(
                    $('<input type="text" class="form-control form-control-sm excel-column">')
                        .attr('placeholder', field.displayName)
                        .val(field.displayName)
                        .data('field-path', field.fieldPath)
                );

                var typeCell = $('<td>').text(field.isRelated ? 'Related' : 'Direct');

                row.append(checkboxCell, fieldCell, excelColumnCell, typeCell);
                tbody.append(row);
            });
        }

        function exportMultiSheet() {
            var sheetConfigurations = [];

            $('.sheet-config').each(function() {
                var sheetElement = $(this);
                var sheetIndex = sheetElement.data('sheet-index');
                var sheetName = sheetElement.find('.sheet-name').val() || 'Sheet' + (sheetIndex + 1);
                var entityType = sheetElement.find('.entity-type').val();
                var startRow = parseInt(sheetElement.find('.start-row').val()) || 1;

                if (!entityType) {
                    return; // Skip sheets without entity type
                }

                var mappings = [];
                sheetElement.find('.field-checkbox').each(function() {
                    var checkbox = $(this);
                    var row = checkbox.closest('tr');
                    var fieldPath = row.find('.excel-column').data('field-path');
                    var excelColumn = row.find('.excel-column').val();
                    var isSelected = checkbox.prop('checked');

                    mappings.push({
                        ApiField: fieldPath,
                        ExcelColumn: excelColumn || fieldPath,
                        IsSelected: isSelected
                    });
                });

                if (mappings.length > 0) {
                    sheetConfigurations.push({
                        SheetName: sheetName,
                        EntityType: entityType,
                        StartRow: startRow,
                        Mappings: mappings
                    });
                }
            });

            if (sheetConfigurations.length === 0) {
                alert('Please configure at least one sheet with fields');
                return;
            }

            $('#loading').show();
            $('#loadingText').text('Fetching data and generating multi-sheet Excel file...');
            $('#error').hide();
            $('#success').hide();

            $.ajax({
                url: '@Url.Action("ExportToExcelMultiSheet", "Excel")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    Sheets: sheetConfigurations,
                    LinkRelatedData: true
                }),
                xhrFields: {
                    responseType: 'blob'
                },
                success: function(blob, status, xhr) {
                    $('#loading').hide();

                    if (blob.type === 'application/json') {
                        var reader = new FileReader();
                        reader.onload = function() {
                            var response = JSON.parse(reader.result);
                            $('#error').text('Error: ' + response.error).show();
                        };
                        reader.readAsText(blob);
                    } else {
                        var filename = xhr.getResponseHeader('Content-Disposition');
                        if (filename) {
                            filename = filename.split('filename=')[1].replace(/"/g, '');
                        } else {
                            filename = 'MultiSheet_Export_' + new Date().toISOString().slice(0,10) + '.xlsx';
                        }

                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        $('#success').text('Multi-sheet Excel file downloaded successfully!').show();

                        setTimeout(function() {
                            $('#success').fadeOut();
                        }, 5000);
                    }
                },
                error: function(xhr, status, error) {
                    $('#loading').hide();

                    if (xhr.responseJSON) {
                        $('#error').text('Error: ' + xhr.responseJSON.error).show();
                    } else {
                        $('#error').text('Export failed: ' + error).show();
                    }
                }
            });
        }
    </script>
}
