@{
    ViewData["Title"] = "Excel Field Mapping";
}

<div class="row mb-3">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")">Home</a></li>
                <li class="breadcrumb-item active">Excel Export</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="btn-group" role="group">
            <a href="@Url.Action("FieldMapping", "Excel")" class="btn btn-primary active">
                <i class="bi bi-file-earmark-excel"></i> Single Sheet Export
            </a>
            <a href="@Url.Action("MultiSheetMapping", "Excel")" class="btn btn-outline-primary">
                <i class="bi bi-files"></i> Multi-Sheet Export
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h3 class="mb-0"><i class="bi bi-file-earmark-excel me-2"></i>Excel Field Mapping & Export</h3>
                <small>Export a single entity type with optional related entity fields</small>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <strong><i class="bi bi-info-circle me-2"></i>Instructions:</strong> Select an entity type, choose fields (including related entity fields), and export to Excel.
                    <br><small class="mt-2 d-block"><strong>Tip:</strong> Related fields like "Asset.Name" let you access data from linked models!</small>
                </div>

                <div class="row mb-4">
                    <div class="col-md-4">
                        <label class="form-label fw-bold">Entity Type</label>
                        <select id="entityType" class="form-select form-select-lg">
                            <option value="">-- Select Entity Type --</option>
                            <option value="assets">Assets</option>
                            <option value="projects">Projects (Work Orders)</option>
                            <option value="defects">Defects (Findings)</option>
                            <option value="measurements">Measurements</option>
                            <option value="inspectionmedia">Inspection Media</option>
                            <option value="checklists">Checklists (Digital Forms)</option>
                            <option value="users">Users</option>
                            <option value="workspaces">Workspaces</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-bold">
                            <i class="bi bi-bookmark me-1"></i>Load Saved Template
                        </label>
                        <select id="templateSelector" class="form-select form-select-lg">
                            <option value="">-- Select Template --</option>
                        </select>
                    </div>
                    <div class="col-md-4 d-flex align-items-end">
                        <button id="loadFieldsBtn" class="btn btn-primary btn-lg w-100">
                            <i class="bi bi-download me-2"></i>Load Fields
                        </button>
                    </div>
                </div>

                <div id="mappingSection" style="display:none;">
                    <hr>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="mb-0">Field Mappings</h5>
                            <p class="text-muted mb-0">Map API fields to Excel column names. Related fields are marked with a badge.</p>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" class="form-check-input" id="selectAll" checked>
                            <label class="form-check-label fw-bold" for="selectAll">Select All</label>
                        </div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="50">Include</th>
                                    <th width="40%">API Field</th>
                                    <th width="30%">Excel Column Name</th>
                                    <th width="30%">Field Type</th>
                                </tr>
                            </thead>
                            <tbody id="mappingTableBody">
                            </tbody>
                        </table>
                    </div>

                    <div class="mt-4">
                        <button id="exportBtn" class="btn btn-success btn-lg px-5">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="bi bi-file-earmark-excel me-2" viewBox="0 0 16 16">
                                <path d="M5.884 6.68a.5.5 0 1 0-.768.64L7.349 10l-2.233 2.68a.5.5 0 0 0 .768.64L8 10.781l2.116 2.54a.5.5 0 0 0 .768-.641L8.651 10l2.233-2.68a.5.5 0 0 0-.768-.64L8 9.219l-2.116-2.54z"/>
                                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
                            </svg>
                            Export to Excel
                        </button>
                        <button id="downloadImagesBtn" class="btn btn-warning btn-lg px-5 ms-2" style="display:none;">
                            <i class="bi bi-images me-2"></i>Download Images
                        </button>
                        <button id="resetBtn" class="btn btn-secondary btn-lg px-5 ms-2">
                            <i class="bi bi-arrow-clockwise me-2"></i>Reset
                        </button>
                        <button id="saveTemplateBtn" class="btn btn-info btn-lg px-5 ms-2">
                            <i class="bi bi-bookmark-plus me-2"></i>Save as Template
                        </button>
                        <a href="@Url.Action("Index", "Template")" class="btn btn-outline-primary btn-lg px-5 ms-2">
                            <i class="bi bi-folder me-2"></i>Manage Templates
                        </a>
                    </div>
                </div>

                <div id="loading" class="alert alert-warning mt-4" style="display:none;">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    <span id="loadingText">Processing...</span>
                </div>

                <div id="error" class="alert alert-danger mt-4" style="display:none;"></div>
                <div id="success" class="alert alert-success mt-4" style="display:none;"></div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-light">
                <h4 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Field Mapping Examples & Tips</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold"><i class="bi bi-check-circle text-success me-1"></i>Direct Field Examples:</h6>
                        <ul class="mb-3">
                            <li><code>Id</code> → "Asset ID"</li>
                            <li><code>Name</code> → "Asset Name"</li>
                            <li><code>CreatedAt</code> → "Created Date"</li>
                            <li><code>Status</code> → "Current Status"</li>
                        </ul>
                        <h6 class="fw-bold"><i class="bi bi-link-45deg text-info me-1"></i>Related Field Examples:</h6>
                        <ul>
                            <li><code>Asset.Name</code> → "Asset Name" (from Project)</li>
                            <li><code>User.Email</code> → "Identified By" (from Defect)</li>
                            <li><code>Project.Status</code> → "Project Status" (from Defect)</li>
                            <li><code>Library.Name</code> → "Library" (from Asset)</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <h6 class="fw-bold"><i class="bi bi-info-circle text-primary me-1"></i>Tips:</h6>
                        <ul>
                            <li><strong>Related Fields:</strong> Access data from linked models using dot notation</li>
                            <li><strong>Field Selection:</strong> Uncheck fields you don't want to include</li>
                            <li><strong>Column Names:</strong> Customize Excel column names or use defaults</li>
                            <li><strong>Quick Toggle:</strong> Use "Select All" to toggle all fields at once</li>
                            <li><strong>Reset:</strong> Click "Reset" to restore default mappings</li>
                            <li><strong>Multi-Sheet:</strong> Need multiple entity types? Try <a href="@Url.Action("MultiSheetMapping", "Excel")">Multi-Sheet Export</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Save Template Modal -->
<div class="modal fade" id="saveTemplateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-bookmark-plus me-2"></i>Save Export Template</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="templateName" class="form-label fw-bold">Template Name</label>
                    <input type="text" class="form-control" id="templateName" placeholder="e.g., Project Export with Assets">
                </div>
                <div class="mb-3">
                    <label for="templateDescription" class="form-label fw-bold">Description (Optional)</label>
                    <textarea class="form-control" id="templateDescription" rows="3" placeholder="Describe what this template is for..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmSaveTemplate">
                    <i class="bi bi-save me-2"></i>Save Template
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        var availableFields = [];
        var currentEntityType = '';

        $(document).ready(function() {
            // Load templates on page load
            loadTemplates();

            $('#loadFieldsBtn').click(function() {
                var entityType = $('#entityType').val();
                if (!entityType) {
                    alert('Please select an entity type');
                    return;
                }

                currentEntityType = entityType;
                loadFields(entityType);

                // Show/hide download images button based on entity type
                if (entityType === 'defects') {
                    $('#downloadImagesBtn').show();
                } else {
                    $('#downloadImagesBtn').hide();
                }
            });

            $('#templateSelector').change(function() {
                var templateId = $(this).val();
                if (templateId) {
                    loadTemplateById(templateId);
                }
            });

            $('#selectAll').change(function() {
                $('.field-checkbox').prop('checked', $(this).prop('checked'));
            });

            $('#exportBtn').click(function() {
                exportToExcel();
            });

            $('#resetBtn').click(function() {
                if (currentEntityType) {
                    loadFields(currentEntityType);
                }
            });

            $('#saveTemplateBtn').click(function() {
                if (!currentEntityType || availableFields.length === 0) {
                    alert('Please load fields first before saving a template');
                    return;
                }
                $('#saveTemplateModal').modal('show');
            });

            $('#confirmSaveTemplate').click(function() {
                saveTemplate();
            });

            $('#downloadImagesBtn').click(function() {
                downloadDefectImages();
            });
        });

        function loadFields(entityType) {
            $('#loading').show();
            $('#loadingText').text('Loading fields with relationships...');
            $('#error').hide();
            $('#success').hide();

            $.ajax({
                url: '@Url.Action("GetAvailableFieldsWithRelationships", "Excel")',
                type: 'GET',
                data: { entityType: entityType },
                success: function(response) {
                    $('#loading').hide();

                    if (response.success) {
                        availableFields = response.fields;
                        renderFieldMappings(response.fields);
                        $('#mappingSection').show();
                    } else {
                        $('#error').text('Error: ' + response.error).show();
                    }
                },
                error: function(xhr, status, error) {
                    $('#loading').hide();
                    $('#error').text('Request failed: ' + error).show();
                }
            });
        }

        function renderFieldMappings(fields) {
            var tbody = $('#mappingTableBody');
            tbody.empty();

            fields.forEach(function(field) {
                var row = $('<tr>');
                var fieldPath = field.fieldPath || field;
                var isRelated = field.isRelated || false;
                var relatedEntity = field.relatedEntity || '';
                var description = field.description || '';

                // Checkbox cell
                var checkboxCell = $('<td class="text-center">').append(
                    $('<input type="checkbox" class="field-checkbox form-check-input">')
                        .prop('checked', true)
                        .data('field-path', fieldPath)
                );

                // Field cell with badge
                var fieldCell = $('<td>').html('<code>' + fieldPath + '</code>');
                if (isRelated) {
                    fieldCell.append(' <span class="badge bg-info">Related: ' + relatedEntity + '</span>');
                } else {
                    fieldCell.append(' <span class="badge bg-secondary">Direct</span>');
                }
                if (description) {
                    fieldCell.append('<br><small class="text-muted">' + description + '</small>');
                }

                // Excel column cell
                var displayName = field.displayName || fieldPath;
                var excelColumnCell = $('<td>').append(
                    $('<input type="text" class="form-control excel-column">')
                        .attr('placeholder', displayName)
                        .data('field-path', fieldPath)
                        .val(displayName)
                );

                // Type cell
                var typeCell = $('<td>');
                if (isRelated) {
                    typeCell.html('<i class="bi bi-link-45deg text-info"></i> Related');
                } else {
                    typeCell.html('<i class="bi bi-check-circle text-success"></i> Direct');
                }

                row.append(checkboxCell, fieldCell, excelColumnCell, typeCell);
                tbody.append(row);
            });
        }

        function formatFieldName(field) {
            // Convert camelCase to Title Case
            return field
                .replace(/([A-Z])/g, ' $1')
                .replace(/^./, function(str) { return str.toUpperCase(); })
                .trim();
        }

        function exportToExcel() {
            var mappings = [];

            $('.field-checkbox').each(function() {
                var checkbox = $(this);
                var fieldPath = checkbox.data('field-path');
                var excelColumn = $('.excel-column[data-field-path="' + fieldPath + '"]').val() || fieldPath;
                var isSelected = checkbox.prop('checked');

                mappings.push({
                    ApiField: fieldPath,
                    ExcelColumn: excelColumn,
                    IsSelected: isSelected
                });
            });

            if (!mappings.some(m => m.IsSelected)) {
                alert('Please select at least one field to export');
                return;
            }

            $('#loading').show();
            $('#loadingText').text('Fetching data and generating Excel file...');
            $('#error').hide();
            $('#success').hide();

            $.ajax({
                url: '@Url.Action("ExportToExcel", "Excel")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    EntityType: currentEntityType,
                    Mappings: mappings
                }),
                xhrFields: {
                    responseType: 'blob'
                },
                success: function(blob, status, xhr) {
                    $('#loading').hide();

                    // Check if response is JSON (error) or blob (file)
                    if (blob.type === 'application/json') {
                        // It's an error response
                        var reader = new FileReader();
                        reader.onload = function() {
                            var response = JSON.parse(reader.result);
                            $('#error').text('Error: ' + response.error).show();
                        };
                        reader.readAsText(blob);
                    } else {
                        // It's a file, trigger download
                        var filename = xhr.getResponseHeader('Content-Disposition');
                        if (filename) {
                            filename = filename.split('filename=')[1].replace(/"/g, '');
                        } else {
                            filename = currentEntityType + '_' + new Date().toISOString().slice(0,10) + '.xlsx';
                        }

                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        $('#success').html('<i class="bi bi-check-circle me-2"></i>Excel file downloaded successfully! <strong>' + (mappings.filter(m => m.IsSelected).length) + '</strong> fields exported.').show();

                        setTimeout(function() {
                            $('#success').fadeOut();
                        }, 5000);
                    }
                },
                error: function(xhr, status, error) {
                    $('#loading').hide();

                    if (xhr.responseJSON) {
                        $('#error').text('Error: ' + xhr.responseJSON.error).show();
                    } else {
                        $('#error').text('Export failed: ' + error).show();
                    }
                }
            });
        }

        function loadTemplates() {
            $.ajax({
                url: '@Url.Action("GetTemplatesByType", "Template")',
                type: 'GET',
                data: { type: 0 }, // 0 = SingleSheet
                success: function(response) {
                    if (response.success && response.templates) {
                        var selector = $('#templateSelector');
                        selector.empty().append('<option value="">-- Select Template --</option>');
                        response.templates.forEach(function(template) {
                            selector.append('<option value="' + template.id + '">' + template.name + '</option>');
                        });
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Failed to load templates:', error);
                }
            });
        }

        function loadTemplateById(templateId) {
            $('#loading').show();
            $('#loadingText').text('Loading template...');
            $('#error').hide();
            $('#success').hide();

            $.ajax({
                url: '@Url.Action("GetTemplate", "Template")',
                type: 'GET',
                data: { id: templateId },
                success: function(response) {
                    $('#loading').hide();

                    if (response.success && response.template && response.template.singleSheetConfig) {
                        var config = response.template.singleSheetConfig;

                        // Set entity type
                        $('#entityType').val(config.entityType);
                        currentEntityType = config.entityType;

                        // Load fields and apply the mappings from template
                        $.ajax({
                            url: '@Url.Action("GetAvailableFieldsWithRelationships", "Excel")',
                            type: 'GET',
                            data: { entityType: config.entityType },
                            success: function(fieldResponse) {
                                if (fieldResponse.success) {
                                    availableFields = fieldResponse.fields;

                                    // Render with template mappings
                                    renderFieldMappingsFromTemplate(fieldResponse.fields, config.mappings);
                                    $('#mappingSection').show();

                                    $('#success').html('<i class="bi bi-check-circle me-2"></i>Template loaded: <strong>' + response.template.name + '</strong>').show();
                                    setTimeout(function() {
                                        $('#success').fadeOut();
                                    }, 3000);
                                }
                            }
                        });
                    } else {
                        $('#error').text('Error: Invalid template').show();
                    }
                },
                error: function(xhr, status, error) {
                    $('#loading').hide();
                    $('#error').text('Failed to load template: ' + error).show();
                }
            });
        }

        function renderFieldMappingsFromTemplate(fields, templateMappings) {
            var tbody = $('#mappingTableBody');
            tbody.empty();

            // Create a map of template mappings for quick lookup
            var mappingMap = {};
            templateMappings.forEach(function(m) {
                mappingMap[m.apiField] = m;
            });

            fields.forEach(function(field) {
                var row = $('<tr>');
                var fieldPath = field.fieldPath || field;
                var isRelated = field.isRelated || false;
                var relatedEntity = field.relatedEntity || '';
                var description = field.description || '';

                // Check if this field has a template mapping
                var templateMapping = mappingMap[fieldPath];
                var isSelected = templateMapping ? templateMapping.isSelected : true;
                var excelColumnValue = templateMapping ? templateMapping.excelColumn : field.displayName || fieldPath;

                // Checkbox cell
                var checkboxCell = $('<td class="text-center">').append(
                    $('<input type="checkbox" class="field-checkbox form-check-input">')
                        .prop('checked', isSelected)
                        .data('field-path', fieldPath)
                );

                // Field cell with badge
                var fieldCell = $('<td>').html('<code>' + fieldPath + '</code>');
                if (isRelated) {
                    fieldCell.append(' <span class="badge bg-info">Related: ' + relatedEntity + '</span>');
                } else {
                    fieldCell.append(' <span class="badge bg-secondary">Direct</span>');
                }
                if (description) {
                    fieldCell.append('<br><small class="text-muted">' + description + '</small>');
                }

                // Excel column cell
                var excelColumnCell = $('<td>').append(
                    $('<input type="text" class="form-control excel-column">')
                        .attr('placeholder', field.displayName || fieldPath)
                        .data('field-path', fieldPath)
                        .val(excelColumnValue)
                );

                // Type cell
                var typeCell = $('<td>');
                if (isRelated) {
                    typeCell.html('<i class="bi bi-link-45deg text-info"></i> Related');
                } else {
                    typeCell.html('<i class="bi bi-check-circle text-success"></i> Direct');
                }

                row.append(checkboxCell, fieldCell, excelColumnCell, typeCell);
                tbody.append(row);
            });
        }

        function saveTemplate() {
            var templateName = $('#templateName').val().trim();
            if (!templateName) {
                alert('Please enter a template name');
                return;
            }

            var mappings = [];
            $('.field-checkbox').each(function() {
                var checkbox = $(this);
                var fieldPath = checkbox.data('field-path');
                var excelColumn = $('.excel-column[data-field-path="' + fieldPath + '"]').val() || fieldPath;
                var isSelected = checkbox.prop('checked');

                mappings.push({
                    ApiField: fieldPath,
                    ExcelColumn: excelColumn,
                    IsSelected: isSelected
                });
            });

            var templateData = {
                Name: templateName,
                Description: $('#templateDescription').val().trim(),
                Type: 0, // SingleSheet
                SingleSheetConfig: {
                    EntityType: currentEntityType,
                    Mappings: mappings
                }
            };

            $.ajax({
                url: '@Url.Action("SaveTemplate", "Template")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(templateData),
                success: function(response) {
                    if (response.success) {
                        $('#saveTemplateModal').modal('hide');
                        $('#templateName').val('');
                        $('#templateDescription').val('');

                        $('#success').html('<i class="bi bi-check-circle me-2"></i>Template saved successfully: <strong>' + templateName + '</strong>').show();

                        // Reload templates
                        loadTemplates();

                        setTimeout(function() {
                            $('#success').fadeOut();
                        }, 3000);
                    } else {
                        alert('Error saving template: ' + response.error);
                    }
                },
                error: function(xhr, status, error) {
                    alert('Failed to save template: ' + error);
                }
            });
        }

        function downloadDefectImages() {
            if (currentEntityType !== 'defects') {
                alert('This feature is only available for Defects');
                return;
            }

            // Show modal to select specific defect or download all
            var defectId = prompt('Enter a Defect ID to download its images, or leave blank to download images from all defects:');

            if (defectId === null) {
                // User cancelled
                return;
            }

            if (defectId && defectId.trim() !== '') {
                // Download images for specific defect
                downloadSingleDefectImages(defectId.trim());
            } else {
                alert('Downloading images for all defects is not yet implemented. Please specify a Defect ID.');
                // TODO: Implement bulk download for all defects
                // This would require fetching all defects first, then downloading images for each
            }
        }

        function downloadSingleDefectImages(defectId) {
            $('#loading').show();
            $('#loadingText').text('Downloading images for defect ' + defectId + '...');
            $('#error').hide();
            $('#success').hide();

            $.ajax({
                url: '@Url.Action("DownloadDefectImages", "Image")',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    DefectId: defectId
                }),
                xhrFields: {
                    responseType: 'blob'
                },
                success: function(blob, status, xhr) {
                    $('#loading').hide();

                    // Check if response is JSON (error) or blob (file)
                    if (blob.type === 'application/json') {
                        // It's an error response
                        var reader = new FileReader();
                        reader.onload = function() {
                            var response = JSON.parse(reader.result);
                            $('#error').text('Error: ' + response.error).show();
                        };
                        reader.readAsText(blob);
                    } else {
                        // It's a file, trigger download
                        var filename = xhr.getResponseHeader('Content-Disposition');
                        if (filename) {
                            filename = filename.split('filename=')[1].replace(/"/g, '');
                        } else {
                            filename = 'defect_' + defectId + '_images.zip';
                        }

                        var url = window.URL.createObjectURL(blob);
                        var a = document.createElement('a');
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);

                        $('#success').html('<i class="bi bi-check-circle me-2"></i>Images downloaded successfully for defect <strong>' + defectId + '</strong>!').show();

                        setTimeout(function() {
                            $('#success').fadeOut();
                        }, 5000);
                    }
                },
                error: function(xhr, status, error) {
                    $('#loading').hide();

                    if (xhr.responseJSON) {
                        $('#error').text('Error: ' + xhr.responseJSON.error).show();
                    } else if (xhr.responseText) {
                        try {
                            var errorResponse = JSON.parse(xhr.responseText);
                            $('#error').text('Error: ' + errorResponse.error).show();
                        } catch (e) {
                            $('#error').text('Download failed: ' + error).show();
                        }
                    } else {
                        $('#error').text('Download failed: ' + error).show();
                    }
                }
            });
        }
    </script>
}
